<div class="mission-detail-page bg-[#07040a]">
    <!-- Ambient Background Lighting -->
    <div class="ambient-glow ambient-glow-1"></div>
    <div class="ambient-glow ambient-glow-2"></div>

    @if (isLoading()) {
    <div class="flex flex-col items-center justify-center min-h-[60vh] relative z-10">
        <div class="relative w-24 h-24 mb-8">
            <div class="absolute inset-0 border-4 border-primary/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            <div
                class="absolute inset-4 border-2 border-primary/40 border-b-transparent rounded-full animate-spin-slow">
            </div>
        </div>
        <p class="text-sm font-black tracking-[0.5em] text-primary animate-pulse">ESTABLISHING SECURE UPLINK...</p>
    </div>
    }

    @else if (error()) {
    <div class="flex flex-col items-center justify-center min-h-[60vh] text-red-500 relative z-10 p-12 text-center">
        <div
            class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mb-6 border border-red-500/20">
            <span class="material-icons text-4xl">gpp_maybe</span>
        </div>
        <h2 class="text-3xl font-black tracking-tight mb-4">CRITICAL UPLINK ERROR</h2>
        <p class="text-sm text-red-500/60 max-w-md mb-10 leading-relaxed">{{ error() }}</p>
        <button (click)="loadMissionData()" class="action-btn-v2 danger px-12">
            RETRY HANDSHAKE
        </button>
    </div>
    }

    @else if (mission(); as m) {
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 p-4 md:p-10 relative z-10 max-w-7xl mx-auto">

        <!-- LEFT COLUMN: OPERATIONAL MEDIA & SQUAD -->
        <div class="lg:col-span-5 space-y-10 animate-fade-in-up">

            <!-- 3D HERO IMAGE -->
            <div class="hero-image-v2 aspect-[4/5] sm:aspect-square lg:aspect-[4/5]" [appThreeDTilt]="30">
                <img [src]="m.image_url || 'https://images.unsplash.com/photo-1614728263952-84ea256f9679?q=80&w=1000&auto=format&fit=crop'"
                    alt="Operation Media" class="w-full h-full object-cover">
                <div class="img-scanlines"></div>

                <!-- Overlay Decorations -->
                <div
                    class="absolute top-8 left-8 p-4 bg-black/40 backdrop-blur-md rounded-2xl border border-white/10 z-10">
                    <span class="text-[10px] font-black tracking-[0.3em] text-white/80 uppercase">{{ m.category ||
                        'OPERATION' }}</span>
                </div>

                @if (isChief()) {
                <div class="absolute top-8 right-8 z-10 flex flex-col items-end gap-2">
                    <button (click)="imageInput.click()"
                        class="px-4 py-2 bg-primary/20 hover:bg-primary/40 backdrop-blur-md border border-primary/30 rounded-xl text-[10px] font-black tracking-widest text-primary uppercase transition-all flex items-center gap-2">
                        <span class="material-icons text-sm">photo_camera</span>
                        Update Intel
                    </button>
                    <input #imageInput type="file" (change)="onImageUpload($event)" accept="image/*" class="hidden">
                    <p class="text-[8px] font-black text-white/40 tracking-tighter uppercase mr-2">CHIEF PROTOCOL</p>
                </div>
                }

                <div class="absolute bottom-10 left-10 right-10 z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <span
                            class="px-3 py-1 bg-white/10 backdrop-blur-md border border-white/10 rounded-full text-[10px] font-black tracking-widest text-primary-400 uppercase">
                            STATUS: {{ m.status }}
                        </span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tighter text-white leading-none uppercase">{{
                        m.name }}</h1>
                </div>

                <!-- Glare and Tech Brackets for Image -->
                <div class="tech-corner tech-corner-tl"></div>
                <div class="tech-corner tech-corner-tr"></div>
                <div class="tech-corner tech-corner-bl"></div>
                <div class="tech-corner tech-corner-br"></div>
            </div>

            <!-- SQUAD ROSTER CARD -->
            <div class="premium-card p-10 space-y-8 animate-float" style="animation-delay: 2s">
                <div class="tech-corner tech-corner-tl opacity-40"></div>
                <div class="tech-corner tech-corner-br opacity-40"></div>

                <div class="flex items-center justify-between border-b border-white/5 pb-6">
                    <div>
                        <h3 class="text-xs font-black tracking-[0.4em] text-white/30 uppercase mb-1">Active Squad</h3>
                        <p class="text-xl font-black text-white">DEPLOIMENT STATUS</p>
                    </div>
                    <div class="text-right">
                        <span class="text-3xl font-black text-primary">{{ crew().length }}</span>
                        <span class="text-xs font-bold text-white/20 ml-2">/ {{ m.max_crew }}</span>
                    </div>
                </div>

                <div class="space-y-4 max-h-[400px] overflow-y-auto custom-scrollbar pr-4">
                    @for (member of crew(); track member.id) {
                    <div class="brawler-row group">
                        <div class="avatar-wrapper">
                            <img [src]="member.avatar_url || 'https://api.dicebear.com/7.x/bottts/svg?seed=' + member.display_name"
                                class="w-full h-full rounded-2xl border-2 border-white/5 avatar-img transition-all bg-black p-0.5"
                                alt="avatar">
                            <div class="status-dot"></div>
                        </div>
                        <div class="flex-grow">
                            <p class="text-base font-black text-white group-hover:text-primary transition-colors">{{
                                member.display_name }}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span
                                    class="text-[9px] font-black tracking-[0.2em] px-2 py-0.5 rounded bg-white/5 text-white/40 uppercase">
                                    {{ member.id === m.chief_id ? 'CHIEF' : 'BRAWLER' }}
                                </span>
                            </div>
                        </div>
                        @if (isChief() && member.id !== _passport.userId()) {
                        <button (click)="false"
                            class="p-2 text-white/10 hover:text-red-500 hover:bg-red-500/10 rounded-xl transition-all material-icons"
                            title="Kick Member">
                            Remove
                        </button>
                        }
                    </div>
                    } @empty {
                    <div class="py-12 text-center border-2 border-dashed border-white/5 rounded-[2.5rem]">
                        <span class="material-icons text-white/10 text-4xl mb-4">radar</span>
                        <p class="text-xs font-black text-white/20 tracking-[0.3em] uppercase">Awaiting Personnel</p>
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: INTEL & COMMS -->
        <div class="lg:col-span-7 flex flex-col space-y-10 animate-fade-in-up" style="animation-delay: 0.1s">

            <!-- MISSION INTEL CARD -->
            <div class="premium-card p-10 space-y-10 animate-float-delayed">
                <div class="flex items-center gap-4 text-primary/40">
                    <span
                        class="w-2 h-2 rounded-full bg-primary animate-pulse shadow-[0_0_15px_rgba(124,58,237,0.8)]"></span>
                    <span class="text-[10px] font-black tracking-[0.5em] uppercase">MISSION DETAILS #{{ m.id }}</span>
                </div>

                <p class="text-2xl md:text-3xl leading-snug text-white/90 font-medium tracking-tight">
                    {{ m.description || 'Secure communication established. No specialized briefing data available for
                    this operation.' }}
                </p>

                <!-- REWARDS GRID -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-white/5">
                    <div class="reward-orb token">
                        <div class="icon-box">ðŸ’°</div>
                        <div>
                            <p class="text-[10px] font-black tracking-[0.3em] text-white/20 uppercase mb-1">TOKENS</p>
                            <p class="text-3xl font-black text-white">2,500</p>
                        </div>
                    </div>
                    <div class="reward-orb xp">
                        <div class="icon-box">âš¡</div>
                        <div>
                            <p class="text-[10px] font-black tracking-[0.3em] text-white/20 uppercase mb-1">EXP DATA</p>
                            <p class="text-3xl font-black text-white">500 XP</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MISSION COMMS CARD -->
            <div class="flex-col premium-card h-[600px] flex">
                @if (isMember() || isChief()) {
                <div class="flex flex-col h-full overflow-hidden">
                    <!-- Chat Header -->
                    <div
                        class="px-10 py-6 border-b border-white/5 flex items-center justify-between bg-white/[0.01] flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <div class="w-2 h-10 bg-primary rounded-full"></div>
                            <div>
                                <h3 class="text-xs font-black tracking-[0.3em] text-white/40 uppercase mb-1">
                                    SQUAD CHANNEL</h3>
                                <p class="text-lg font-black text-white">Team Chat</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-black text-emerald-500 tracking-widest">ACTIVE LINK</span>
                            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_10px_#10b981]">
                            </div>
                        </div>
                    </div>
                    <!-- Chat Component -->
                    <div class="flex-1 relative overflow-hidden min-h-0">
                        <app-mission-chat [missionId]="m.id" [chiefId]="m.chief_id"
                            [isReadOnly]="m.status === 'Completed'"></app-mission-chat>
                    </div>
                </div>
                } @else {
                <div class="flex-grow flex flex-col items-center justify-center p-12 text-center group h-full">
                    <div class="relative w-32 h-32 mb-10">
                        <div
                            class="absolute inset-0 bg-primary/20 blur-3xl group-hover:bg-primary/40 transition-all rounded-full scale-150">
                        </div>
                        <div
                            class="relative w-full h-full bg-black/60 border border-white/10 rounded-full flex items-center justify-center shadow-2xl overflow-hidden">
                            <span
                                class="material-icons text-primary/60 text-6xl group-hover:scale-110 transition-transform duration-500">fingerprint</span>
                            <div class="absolute inset-0 bg-gradient-to-t from-primary/20 to-transparent opacity-50">
                            </div>
                        </div>
                    </div>
                    <h3 class="text-3xl font-black mb-4 text-white tracking-tighter">ENCRYPTION DETECTED</h3>
                    <p class="text-sm text-white/40 max-w-sm mb-12 leading-relaxed font-medium">
                        Operational frequency is restricted. Establish identity by joining the protocol.
                    </p>

                    <button (click)="joinMission()" class="action-btn-v2 primary px-16 group/btn">
                        <span class="relative z-10 flex items-center gap-4">
                            ACCEPT PROTOCOL
                            <span class="material-icons group-hover/btn:translate-x-2 transition-transform">bolt</span>
                        </span>
                    </button>
                </div>
                }
            </div>

            <!-- leave -->
            @if (isMember() && !isChief()) {
            <div class="flex justify-center pt-8 animate-fade-in-up" style="animation-delay: 0.2s">
                <button (click)="leaveMission()"
                    class="action-btn-v2 danger w-full md:w-auto px-12 py-4 shadow-lg shadow-red-500/10 hover:shadow-red-500/20 border border-red-500/20">
                    <span class="material-icons text-red-400">LEAVE</span>
                </button>
            </div>
            }
        </div>
    </div>
    }
</div>