<div class="missions-page">
    <div class="content-wrapper">

        <!-- HEADER -->
        <div class="flex items-center justify-between mb-12">
            <div>
                <h1 class="font-display text-4xl font-black text-white tracking-widest uppercase mb-2">
                    ACTIVE OPERATIONS
                </h1>
                <p class="text-slate-500 text-xs uppercase tracking-[0.3em]">
                    Real-time mission intelligence and deployment
                </p>
            </div>

            <div class="h-px flex-1 mx-12 bg-primary/20 hidden md:block"></div>
        </div>

        <!-- FILTER PANEL -->
        <div class="filter-panel">
            <div class="search-input-group">
                <svg xmlns="http://www.w3.org/2000/svg"
                    class="absolute left-4 top-1/2 -translate-y-1/2 z-10 pointer-events-none text-white/50 w-5 h-5"
                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" [(ngModel)]="filter.name" placeholder="SEARCH PROTOCOL NAME..."
                    (keyup.enter)="onSubmit()" />
            </div>

            <select [(ngModel)]="filter.status" class="filter-select">
                <option value="">-- ALL STATUS --</option>
                <option value="Open">OPEN</option>
                <option value="InProgress">IN PROGRESS</option>
                <option value="Completed">COMPLETED</option>
                <option value="Failed">FAILED</option>
            </select>

            <select [(ngModel)]="filter.category" class="filter-select">
                <option value="">-- ALL CATEGORIES --</option>
                <option value="Game">GAME</option>
                <option value="General">GENERAL</option>
                <option value="Sport">SPORT</option>
                <option value="Work">WORK</option>
            </select>

            <button (click)="onSubmit()" class="filter-btn">
                SYNC DATA
            </button>
        </div>

        <!-- MISSIONS GRID -->
        <div class="missions-grid">
            @if (isLoading()) {
            @for (i of [1,2,3,4,5,6]; track i) {
            <div class="mission-card opacity-50 animate-pulse">
                <div class="card-image bg-slate-800"></div>
                <div class="card-content">
                    <div class="h-6 w-3/4 bg-slate-700 mb-4 rounded"></div>
                    <div class="h-4 w-full bg-slate-800 mb-2 rounded"></div>
                    <div class="h-4 w-5/6 bg-slate-800 mb-6 rounded"></div>
                </div>
            </div>
            }
            } @else {
            @for (mission of missions$ | async; track mission.id) {
            <div class="mission-card group" [appThreeDTilt]="15">
                <!-- Tech Corners -->
                <div
                    class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-primary/60 rounded-tl-2xl z-20 pointer-events-none">
                </div>
                <div
                    class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-primary/60 rounded-tr-2xl z-20 pointer-events-none">
                </div>
                <div
                    class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-primary/60 rounded-bl-2xl z-20 pointer-events-none">
                </div>
                <div
                    class="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-primary/60 rounded-br-2xl z-20 pointer-events-none">
                </div>

                <!-- Scanline -->
                <div
                    class="absolute inset-0 pointer-events-none z-10 opacity-20 bg-[url('/assets/images/scanline.png')] bg-repeat">
                </div>

                <div class="category-tag">{{ mission.category || 'OPERATION' }}</div>

                <div class="card-image holographic-sheen">
                    <img [src]="mission.image_url || '/assets/card/card-img-0' + (mission.id % 4 + 1) + '.jpg'"
                        [alt]="mission.name">
                    <div [class]="'status-badge ' + mission.status">{{ mission.status }}</div>

                    <!-- Gradient Overlay -->
                    <div
                        class="absolute inset-0 bg-gradient-to-t from-[#140c2e] via-transparent to-transparent pointer-events-none">
                    </div>
                </div>

                <div class="card-content">
                    <h4 class="mission-name">{{ mission.name }}</h4>
                    <p class="mission-desc">{{ mission.description }}</p>

                    <div class="card-stats">
                        <div class="stat">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-[#7c3aed]" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span class="truncate max-w-[100px]">{{ mission.chief_display_name }}</span>
                        </div>
                        <div class="stat">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-[#7c3aed]" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span>{{ mission.crew_count }} / {{ mission.max_crew || 5 }}</span>
                        </div>
                    </div>

                    <div class="card-actions">
                        <button (click)="openMissionModal(mission.id)" class="btn-view">
                            VIEW DATA
                        </button>

                        @if (isSignin()) {
                        @if (!mission.is_member && mission.chief_id !== userId()) {
                        <button (click)="joinMission(mission.id)" class="btn-join"
                            [disabled]="mission.crew_count >= mission.max_crew || mission.status === 'Completed' || mission.status === 'Failed'">
                            @if(mission.crew_count >= mission.max_crew) { FULL }
                            @else if(mission.status === 'Completed') { DONE }
                            @else { ENGAGE }
                        </button>
                        } @else {
                        <button class="btn-join" [disabled]="true" [style.background]="'#334155'">
                            @if(mission.chief_id === userId()) { CHIEF }
                            @else { ASSIGNED }
                        </button>
                        }
                        } @else {
                        <button routerLink="/login" class="btn-join">LOGIN</button>
                        }
                    </div>
                </div>
            </div>
            } @empty {
            <div class="empty-state">
                <span class="material-icons">cloud_off</span>
                <p>No active protocols found in current sector.</p>
            </div>
            }
            }
        </div>
    </div>
</div>

<!-- MISSION DETAIL MODAL -->
@if (showModal()) {
<div class="fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-10">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-[#030105]/80 backdrop-blur-md transition-opacity animate-in fade-in duration-500"
        (click)="closeMissionModal()"></div>

    <!-- Modal Container -->
    <div
        class="relative w-full max-w-6xl max-h-[92vh] bg-[#07040a]/90 backdrop-blur-2xl border border-white/10 rounded-[2.5rem] shadow-[0_20px_100px_rgba(0,0,0,0.8),0_0_40px_rgba(124,58,237,0.1)] animate-in zoom-in-95 duration-500 flex flex-col overflow-hidden">

        <!-- Glowing Top Border Decor -->
        <div
            class="absolute top-0 left-1/4 right-1/4 h-[1px] bg-gradient-to-r from-transparent via-primary to-transparent opacity-50 z-[120]">
        </div>

        <!-- Close Button (Fixed at top-right of modal) -->

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scrollbar overflow-x-hidden relative">
            <button (click)="closeMissionModal()"
                class="absolute top-6 right-6 z-[130] text-white transition-colors group opacity-50 hover:opacity-100">
                <span class="text-2xl">‚ùå</span>
            </button>
            <app-mission-detail [id]="selectedMissionId()"></app-mission-detail>
        </div>
    </div>
</div>
}