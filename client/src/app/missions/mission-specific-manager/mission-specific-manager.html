<div class="loading" *ngIf="isLoading">
    <p>Loading mission details...</p>
</div>

<div class="error-container" *ngIf="error">
    <p class="error-msg">{{error}}</p>
    <div class="actions">
        <button (click)="loadData()">Retry</button>
        <button (click)="goBack()">Back</button>
    </div>
</div>

<div class="container" *ngIf="mission && !isLoading && !error">
    <div class="header">
        <button (click)="goBack()">Back</button>
        <h2>Mission Manager</h2>
    </div>

    <div class="mission-details">
        <div *ngIf="!isEditing">
            <h3>{{mission.name}} <span class="badge" [class]="mission.status">{{mission.status}}</span></h3>
            <p>{{mission.description}}</p>
            <div class="actions" *ngIf="mission.status !== 'Completed' && isChief">
                <button (click)="toggleEdit()">Edit Details</button>
                <button (click)="deleteMission()" class="danger">Delete Mission</button>
            </div>
            <div class="actions" *ngIf="!isChief">
                <button (click)="leaveMission()" class="warn">Leave Mission</button>
            </div>
        </div>

        <div *ngIf="isEditing && isChief" class="edit-form">
            <input [(ngModel)]="editName" placeholder="Mission Name" />
            <textarea [(ngModel)]="editDescription" placeholder="Description"></textarea>
            <div class="form-actions">
                <button (click)="saveEdit()">Save</button>
                <button (click)="toggleEdit()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="mission-controls" *ngIf="isChief">
        <button *ngIf="(mission.status === 'Open' || mission.status === 'Failed') && crew.length > 0"
            (click)="startMission()" class="primary">Start Mission</button>
        <button *ngIf="mission.status === 'InProgress'" (click)="completeMission()" class="success">Complete
            Mission</button>
    </div>

    <div style="margin-top: 20px;">
        <h3>Chat</h3>
        <app-mission-chat [missionId]="missionId" [chiefId]="mission.chief_id"></app-mission-chat>
    </div>

    <div class="crew-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Crew Members ({{crew.length}})</h3>
            <button (click)="openInviteDialog()" *ngIf="isChief && mission.status !== 'Completed'">Invite
                Member</button>
        </div>
        <div class="crew-list">
            <div class="crew-item" *ngFor="let member of crew">
                <div class="info">
                    <img [src]="member.avatar_url || 'https://via.placeholder.com/40'" alt="Avatar" class="avatar">
                    <span [class.chief-star]="member.id === mission.chief_id">{{member.display_name}} <span
                            *ngIf="member.id === mission.chief_id">(Chief)</span></span>
                </div>
                <div class="actions"
                    *ngIf="mission.status !== 'Completed' && isChief && member.id !== mission.chief_id">
                    <button (click)="kick(member.id)" class="warn">Kick</button>
                </div>
            </div>
            <div *ngIf="crew.length === 0" class="empty">No crew members yet.</div>
        </div>
    </div>
</div>