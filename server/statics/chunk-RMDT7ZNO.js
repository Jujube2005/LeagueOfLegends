import{D as ne,N as se,b as q,c as G,d as Q,f as K,h as X,k as O,w as M,x as ee,z as te}from"./chunk-PCHQMVQE.js";import{Ab as o,Bb as h,Fb as N,Gb as T,Hb as W,Lb as _,Nb as g,Pa as U,Ra as r,U as f,Wb as w,Yb as c,Z as d,Zb as b,_b as V,ac as H,bc as B,ca as C,cc as Y,da as x,eb as A,h as D,hc as J,jc as $,kb as y,la as z,lc as j,oc as P,pa as E,r as a,rc as Z,s as I,ta as L,yb as p,zb as i}from"./chunk-JZHJ2IWP.js";var ae="/assets/default.avatar.jpg";function F(s){return s&&s.avatar_url?s.avatar_url:ae}var v=class s{_key="passport";_base_url=M.baseUrl+"/api";_http=d(O);data=E(void 0);avatar=E("");userId=P(()=>{let e=this.data();if(e?.token)try{let t=JSON.parse(atob(e.token.split(".")[1]));return Number(t.sub)}catch{return}});xp=P(()=>{let e=this.data();return e?(e.mission_success_count||0)*500+(e.mission_join_count||0)*100:0});level=P(()=>Math.floor(this.xp()/1e3)+1);saveAvatarImgUrl(e){let t=this.data();t&&(t.avatar_url=e,this.avatar.set(e),this.data.set(t),this.savePassportToLocalStorage())}loadPassportFormLocalStorage(){let e=localStorage.getItem(this._key);if(!e)return"not found";try{let t=JSON.parse(e);this.data.set(t);let n=F(t);this.avatar.set(n)}catch(t){return`${t}`}return null}savePassportToLocalStorage(){let e=this.data();if(!e)return;let t=JSON.stringify(e);localStorage.setItem(this._key,t)}constructor(){this.loadPassportFormLocalStorage()}destroy(){this.data.set(void 0),this.avatar.set(""),localStorage.removeItem(this._key)}async get(e){let t=this._base_url+"/authentication/login";return await this.fetchPassport(t,e)}async register(e){let t=this._base_url+"/brawler/register";return await this.fetchPassport(t,e)}async fetchPassport(e,t){try{let n=this._http.post(e,t),l=await a(n);this.data.set(l);let m=F(l);return this.avatar.set(m),this.savePassportToLocalStorage(),null}catch(n){return n.error}}static \u0275fac=function(t){return new(t||s)};static \u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"})};var S=class s{_base_url=M.baseUrl+"/api";_http=d(O);filter={};async getByFilter(e){let t=this.createQueryString(e),n=this._base_url+"/view/filter"+(t?"?"+t:"");return await a(this._http.get(n))}createQueryString(e){this.filter=e;let t=[];return e.name&&e.name.trim()&&t.push(`name=${encodeURIComponent(e.name.trim())}`),e.status&&t.push(`status=${encodeURIComponent(e.status)}`),e.category&&e.category.trim()&&t.push(`category=${encodeURIComponent(e.category.trim())}`),t.join("&")}async add(e){let t=this._base_url+"/mission-management",n=this._http.post(t,e);return(await a(n)).mission_id}async edit(e,t){let n=this._base_url+"/mission-management/"+e;await a(this._http.patch(n,t))}async delete(e){let t=this._base_url+"/mission-management/"+e;await a(this._http.delete(t))}async getMyMissions(){let e=this._base_url+"/brawler/my-missions";console.log("get "+e);let t=this._http.get(e);return await a(t)}async joinMission(e){let t=`${this._base_url}/crew/join/${e}`;await a(this._http.post(t,{}))}async leaveMission(e){let t=`${this._base_url}/crew/leave/${e}`;await a(this._http.delete(t))}async getJoinedMissions(){let e=this._base_url+"/view/joined";return await a(this._http.get(e))}async getPopularMissions(){let e=this._base_url+"/view/popular";return await a(this._http.get(e))}async getMissionSummary(){let e=this._base_url+"/brawler/mission-summary";return await a(this._http.get(e))}async startMission(e){let t=`${this._base_url}/mission/in-progress/${e}`;await a(this._http.patch(t,{}))}async completeMission(e){let t=`${this._base_url}/mission/to-completed/${e}`;await a(this._http.patch(t,{}))}async getMission(e){return a(this._http.get(`${this._base_url}/view/${e}`).pipe(I(5e3)))}async getCrew(e){return a(this._http.get(`${this._base_url}/view/crew/${e}`).pipe(I(5e3)))}async kickCrew(e,t){await a(this._http.post(`${this._base_url}/crew/kick/${e}`,{member_id:t}))}async getMessages(e){let t=`${this._base_url}/mission-chat/${e}/messages`;return a(this._http.get(t))}async sendMessage(e,t){let n=`${this._base_url}/mission-chat/${e}/messages`;await a(this._http.post(n,{content:t}))}static \u0275fac=function(t){return new(t||s)};static \u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"})};var k=class s{socket=null;messageSubject=new D;messages$=this.messageSubject.asObservable();passport=d(v);zone=d(z);connect(e){this.socket&&this.socket.close();let t=this.passport.data()?.token;if(!t){console.error("No token found, cannot connect to Mission WS");return}let n=M.baseUrl;n?n=n.replace("http","ws"):n=`${window.location.protocol.replace("http","ws")}//${window.location.host}`,n.endsWith("/")&&(n=n.slice(0,-1));let l=`${n}/api/ws/mission/${e}?token=${t}`;this.socket=new WebSocket(l),this.socket.onopen=()=>{console.log(`Connected to Mission ${e} Chat Room`)},this.socket.onmessage=m=>{try{let u=JSON.parse(m.data),oe={id:-Date.now(),mission_id:e,user_id:u.user_id,user_display_name:u.user_id===this.passport.userId()?this.passport.data()?.display_name:void 0,user_avatar_url:u.user_id===this.passport.userId()?this.passport.data()?.avatar_url:void 0,content:u.content,type_:u.type,created_at:u.created_at};this.zone.run(()=>{this.messageSubject.next(oe)})}catch(u){console.error("Error parsing WS message",u)}},this.socket.onerror=m=>{console.error("WebSocket error",m)},this.socket.onclose=()=>{}}sendMessage(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(e):console.warn("WebSocket not connected")}disconnect(){this.socket&&(this.socket.close(),this.socket=null)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"})};var re=(s,e,t)=>({system:s,sent:e,received:t});function ce(s,e){s&1&&(i(0,"div",9),h(1,"div",10),i(2,"span"),c(3,"DECRYPTING UPLINK..."),o()())}function le(s,e){s&1&&(i(0,"span",24),c(1,"CHIEF"),o())}function de(s,e){if(s&1&&(N(0),i(1,"div",13),h(2,"div",14)(3,"img",15),o(),i(4,"div",16)(5,"div",17)(6,"span",18),c(7),o(),y(8,le,2,0,"span",19),h(9,"span",20),i(10,"span",21),c(11),$(12,"date"),o()(),i(13,"div",22),c(14),h(15,"div",23),o()(),T()),s&2){let t=g().$implicit,n=g();r(3),p("src",t.user_avatar_url||"https://api.dicebear.com/7.x/bottts/svg?seed="+t.user_display_name,U),r(4),b(t.user_display_name),r(),p("ngIf",n.chiefId&&t.user_id===n.chiefId),r(3),b(j(12,5,t.created_at,"HH:mm")),r(3),V(" ",t.content," ")}}function pe(s,e){if(s&1&&(N(0),i(1,"div",25)(2,"span",26),c(3,"info"),o(),i(4,"span",27),c(5),o(),i(6,"span",28),c(7),$(8,"date"),o()(),T()),s&2){let t=g().$implicit;r(5),b(t.content),r(2),b(j(8,2,t.created_at,"HH:mm"))}}function me(s,e){if(s&1&&(i(0,"div",11),y(1,de,16,8,"ng-container",12)(2,pe,9,5,"ng-container",12),o()),s&2){let t=e.$implicit,n=g();p("ngClass",J(3,re,t.type_==="system",t.type_==="chat"&&t.user_id===n.passport.userId(),t.type_==="chat"&&t.user_id!==n.passport.userId())),r(),p("ngIf",t.type_==="chat"),r(),p("ngIf",t.type_==="system")}}function ge(s,e){s&1&&(i(0,"div",29)(1,"span",3),c(2,"sensors_off"),o(),i(3,"p"),c(4,"NO ACTIVE TRANSMISSIONS DETECTED"),o()())}function ue(s,e){if(s&1){let t=W();i(0,"div",30)(1,"div",31)(2,"input",32),Y("ngModelChange",function(l){C(t);let m=g();return B(m.newMessage,l)||(m.newMessage=l),x(l)}),_("keyup.enter",function(){C(t);let l=g();return x(l.sendMessage())}),o(),h(3,"div",33),o(),i(4,"button",34),_("click",function(){C(t);let l=g();return x(l.sendMessage())}),i(5,"span",3),c(6),o()()()}if(s&2){let t=g();r(2),H("ngModel",t.newMessage),p("placeholder",t.isReadOnly?"CHANNEL ENCRYPTED / MISSION CLOSED":"ENTER SECURE TRANSMISSION...")("disabled",t.sendingMessage||t.isReadOnly),r(2),p("disabled",!t.newMessage.trim()||t.sendingMessage||t.isReadOnly),r(2),b(t.sendingMessage?"sync":t.isReadOnly?"lock":"send")}}var ie=class s{missionId;chiefId;isReadOnly=!1;missionService=d(S);missionSocket=d(k);passport=d(v);cdr=d(Z);messages=[];newMessage="";loadingMessages=!1;sendingMessage=!1;filter="all";get filteredMessages(){return this.filter==="all"?this.messages:this.filter==="activity"?this.messages.filter(e=>e.type_==="system"):this.messages.filter(e=>e.type_===this.filter)}socketSub;async ngOnInit(){this.missionId&&(this.missionSocket.connect(this.missionId),await this.loadMessages()),this.socketSub=this.missionSocket.messages$.subscribe(e=>{this.messages.push(e),this.cdr.detectChanges(),this.scrollToBottom()})}ngOnDestroy(){this.missionSocket.disconnect(),this.socketSub&&this.socketSub.unsubscribe()}async ngOnChanges(e){e.missionId&&!e.missionId.firstChange&&this.missionId&&(this.missionSocket.connect(this.missionId),await this.loadMessages())}async loadMessages(){try{this.loadingMessages=!0,this.cdr.detectChanges(),this.messages=await this.missionService.getMessages(this.missionId),this.messages.forEach(e=>{e.created_at&&!e.created_at.endsWith("Z")&&(e.created_at=e.created_at+"Z")}),this.scrollToBottom()}catch(e){console.error("Failed to load messages",e)}finally{this.loadingMessages=!1,this.cdr.detectChanges()}}async sendMessage(){if(!this.newMessage.trim())return;let e=this.newMessage;this.newMessage="",this.missionSocket.sendMessage(e)}scrollToBottom(){setTimeout(()=>{let e=document.querySelector(".messages-list");e&&(e.scrollTop=e.scrollHeight)},100)}static \u0275fac=function(t){return new(t||s)};static \u0275cmp=A({type:s,selectors:[["app-mission-chat"]],inputs:{missionId:"missionId",chiefId:"chiefId",isReadOnly:"isReadOnly"},features:[L],decls:19,vars:10,consts:[[1,"chat-container"],[1,"tabs"],[3,"click"],[1,"material-symbols-outlined"],[1,"messages-list","custom-scrollbar"],["class","loading-state",4,"ngIf"],["class","message-wrapper",3,"ngClass",4,"ngFor","ngForOf"],["class","empty-state",4,"ngIf"],["class","input-area",4,"ngIf"],[1,"loading-state"],[1,"scanner"],[1,"message-wrapper",3,"ngClass"],[4,"ngIf"],[1,"avatar-container"],[1,"avatar-ring"],[1,"avatar-img",3,"src"],[1,"message-body"],[1,"message-header"],[1,"sender"],["class","chief-tag",4,"ngIf"],[1,"dot"],[1,"time"],[1,"bubble"],[1,"bubble-glow"],[1,"chief-tag"],[1,"system-log"],[1,"material-symbols-outlined","log-icon"],[1,"log-content"],[1,"log-time"],[1,"empty-state"],[1,"input-area"],[1,"input-wrapper"],["type","text",3,"ngModelChange","keyup.enter","ngModel","placeholder","disabled"],[1,"input-glow"],[1,"send-btn",3,"click","disabled"]],template:function(t,n){t&1&&(i(0,"div",0)(1,"div",1)(2,"button",2),_("click",function(){return n.filter="all"}),i(3,"span",3),c(4,"dvr"),o(),c(5," ALL LOGS "),o(),i(6,"button",2),_("click",function(){return n.filter="chat"}),i(7,"span",3),c(8,"forum"),o(),c(9," COMMS "),o(),i(10,"button",2),_("click",function(){return n.filter="activity"}),i(11,"span",3),c(12,"analytics"),o(),c(13," INTEL "),o()(),i(14,"div",4),y(15,ce,4,0,"div",5)(16,me,3,7,"div",6)(17,ge,5,0,"div",7),o(),y(18,ue,7,5,"div",8),o()),t&2&&(r(2),w("active",n.filter==="all"),r(4),w("active",n.filter==="chat"),r(4),w("active",n.filter==="activity"),r(5),p("ngIf",n.loadingMessages),r(),p("ngForOf",n.filteredMessages),r(),p("ngIf",!n.loadingMessages&&n.filteredMessages.length===0),r(),p("ngIf",n.filter!=="activity"))},dependencies:[X,q,G,Q,se,ee,te,ne,K],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%;background:transparent;color:#e2e8f0;font-family:Outfit,sans-serif;overflow:hidden}.tabs[_ngcontent-%COMP%]{display:flex;background:#7c3aed08;border-bottom:1px solid rgba(255,255,255,.03);padding:.5rem;gap:.5rem}.tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;gap:.5rem;background:transparent;border:1px solid transparent;color:#ffffff4d;padding:10px;font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:.2em;cursor:pointer;border-radius:12px;transition:all .4s cubic-bezier(.16,1,.3,1)}.tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   .material-symbols-outlined[_ngcontent-%COMP%]{font-size:14px;opacity:.6}.tabs[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:#ffffff08;color:#fff9}.tabs[_ngcontent-%COMP%]   button.active[_ngcontent-%COMP%]{background:#7c3aed1a;color:#a78bfa;border-color:#7c3aed33;box-shadow:inset 0 0 10px #7c3aed1a}.tabs[_ngcontent-%COMP%]   button.active[_ngcontent-%COMP%]   .material-symbols-outlined[_ngcontent-%COMP%]{opacity:1;color:#7c3aed}.messages-list[_ngcontent-%COMP%]{flex:1;overflow-y:auto;overscroll-behavior:none;padding:1.5rem;display:flex;flex-direction:column;gap:1.5rem;background:radial-gradient(circle at 50% 10%,rgba(124,58,237,.05),transparent 60%)}.messages-list[_ngcontent-%COMP%]::-webkit-scrollbar{width:3px}.messages-list[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#7c3aed33;border-radius:10px}.message-wrapper[_ngcontent-%COMP%]{display:flex;gap:1rem;max-width:85%;animation:_ngcontent-%COMP%_messageSlide .4s cubic-bezier(.16,1,.3,1) forwards}@keyframes _ngcontent-%COMP%_messageSlide{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.sent[_ngcontent-%COMP%]{align-self:flex-end;flex-direction:row-reverse}.sent[_ngcontent-%COMP%]   .message-body[_ngcontent-%COMP%]{align-items:flex-end}.sent[_ngcontent-%COMP%]   .message-header[_ngcontent-%COMP%]{flex-direction:row-reverse}.sent[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border-radius:20px 4px 20px 20px;box-shadow:0 10px 25px -5px #7c3aed66;border:1px solid rgba(255,255,255,.1)}.received[_ngcontent-%COMP%]{align-self:flex-start}.received[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:#ffffff08;-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);color:#e2e8f0;border-radius:4px 20px 20px;border:1px solid rgba(255,255,255,.05)}.avatar-container[_ngcontent-%COMP%]{position:relative;flex-shrink:0;width:36px;height:36px}.avatar-ring[_ngcontent-%COMP%]{position:absolute;inset:-2px;border:1px solid rgba(124,58,237,.3);border-radius:full;opacity:.5}.avatar-img[_ngcontent-%COMP%]{width:100%;height:100%;border-radius:50%;background:#0f172a;border:1px solid rgba(255,255,255,.1)}.message-body[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.4rem}.message-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.sender[_ngcontent-%COMP%]{font-size:.65rem;font-weight:900;letter-spacing:.05em;color:#ffffff80;text-transform:uppercase}.chief-tag[_ngcontent-%COMP%]{font-size:.55rem;background:gold;color:#000;padding:1px 6px;border-radius:4px;font-weight:900;letter-spacing:0}.time[_ngcontent-%COMP%]{font-size:.6rem;color:#fff3;font-weight:600}.dot[_ngcontent-%COMP%]{width:2px;height:2px;background:#fff3;border-radius:100%}.bubble[_ngcontent-%COMP%]{padding:.8rem 1.2rem;font-size:.85rem;line-height:1.5;position:relative;overflow:hidden}.system[_ngcontent-%COMP%]{max-width:100%;width:100%;justify-content:center}.system-log[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;padding:.6rem 1.2rem;background:#7c3aed0d;border:1px dashed rgba(124,58,237,.2);border-radius:10px;width:fit-content}.log-icon[_ngcontent-%COMP%]{font-size:14px;color:#7c3aed}.log-content[_ngcontent-%COMP%]{font-size:.7rem;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:.05em}.log-time[_ngcontent-%COMP%]{font-size:.55rem;color:#7c3aed4d}.input-area[_ngcontent-%COMP%]{padding:1rem 1.5rem;background:#0000004d;border-top:1px solid rgba(255,255,255,.05);display:flex;gap:1rem;align-items:center}.input-wrapper[_ngcontent-%COMP%]{flex:1;position:relative}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;background:#ffffff08;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:0 20px;color:#fff;font-size:.85rem;font-weight:600;letter-spacing:.03em;transition:all .4s;height:48px;box-sizing:border-box}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none;background:#7c3aed14;border-color:#7c3aed66;box-shadow:0 0 15px #7c3aed1a}.send-btn[_ngcontent-%COMP%]{width:48px;height:48px;background:#7c3aed;color:#fff;border:none;border-radius:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s cubic-bezier(.16,1,.3,1);box-shadow:0 8px 16px -4px #7c3aed66}.send-btn[_ngcontent-%COMP%]   .material-symbols-outlined[_ngcontent-%COMP%]{font-size:24px;transition:transform .3s}.send-btn[_ngcontent-%COMP%]:hover:not(:disabled){transform:scale(1.05) translateY(-2px);filter:brightness(1.1)}.send-btn[_ngcontent-%COMP%]:hover:not(:disabled)   .material-symbols-outlined[_ngcontent-%COMP%]{transform:translate(2px) rotate(-10deg)}.send-btn[_ngcontent-%COMP%]:disabled{background:#ffffff0d;color:#ffffff1a;box-shadow:none;cursor:not-allowed}.loading-state[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;color:#fff3;padding:3rem;font-weight:800;font-size:.65rem;letter-spacing:.3em}.scanner[_ngcontent-%COMP%]{width:40px;height:2px;background:#7c3aed;box-shadow:0 0 15px #7c3aed;animation:_ngcontent-%COMP%_scannerMove 1.5s ease-in-out infinite}@keyframes _ngcontent-%COMP%_scannerMove{0%,to{transform:translateY(-10px);opacity:0}50%{transform:translateY(10px);opacity:1}}"]})};export{v as a,S as b,k as c,ie as d};
